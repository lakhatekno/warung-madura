<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
</head>
<body>
  <h1>Warmad</h1>
  <section id="content">
    <div id="content_body"></div>
  </section>
  <section id="form-container">
    <h3 id="form-title">tambah barang</h3>
    <form id="form_add">
      <label for="id_barang">ID Barang</label>
      <input type="number" placeholder="id barang" id="id_barang" name="id_barang">
      <br>
      <label for="nama_barang">Nama Barang</label>
      <input type="text" placeholder="nama barang" id="nama_barang" name="nama_barang">
      <br>
      <label for="stok">Stok</label>
      <input type="number" placeholder="stok" id="stok" name="stok">
      <br>
      <label for="harga_jual">Harga Jual</label>
      <input type="number" step="0.001" placeholder="harga jual" id="harga_jual" name="harga_jual">
      <br>
      <button type="submit">Tambah</button>
    </form>
  </section>

  <script>
    const container = document.querySelector('#content_body');
    const form = document.querySelector('#form_add');

    const getData = async () => {
      try {
        const response = await fetch('https://api-warung-madura-dot-c-03-414902.et.r.appspot.com/gudang', {
          method: 'GET'
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json(); // Assuming the response is JSON
        console.log(data)
        return data;
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    };

    const postToGudang = async (body) => {
      try {
        const response = await fetch('https://api-warung-madura-dot-c-03-414902.et.r.appspot.com/gudang', {
          method: 'POST',
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return await response;
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    };

    const updateToGudang = async (id_barang, body) => {
      try {
        const response = await fetch(`https://api-warung-madura-dot-c-03-414902.et.r.appspot.com/gudang/${id_barang}`, {
          method: 'PUT',
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return await response;
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }

    const buildSectionUpdateGudang = (data) => {
      container.innerHTML = '<h3>update gudang</h3>'
      container.innerHTML += `
      <form id="form_update">
        <label for="id_barang_update">ID Barang</label>
        <br>
        <input type="number" placeholder="id barang" id="id_barang_update" name="id_barang_update" value=${data.id_barang} disabled>
        <br>
        <label for="nama_barang_update">Nama Barang</label>
        <br>
        <input type="text" placeholder="nama barang" id="nama_barang_update" name="nama_barang_update" value=${data.nama_barang}>
        <br>
        <label for="stok_update">Stok</label>
        <br>
        <input type="number" placeholder="stok" id="stok_update" name="stok_update" value=${data.stok}>
        <br>
        <label for="harga_jual_update">Harga Jual</label>
        <br>
        <input type="number" step="0.001" placeholder="harga jual" id="harga_jual_update" name="harga_jual_update" value=${data.harga_jual}>
        <br>
        <button type="submit">Update</button>
      </form>
      `

      const form = document.querySelector('#form_update');
      form.addEventListener('submit', async (event) => {
        event.preventDefault(); // Prevent default form submission

        const body = {
          "nama_barang": document.getElementById('nama_barang_update').value,
          "stok": parseInt(document.getElementById('stok_update').value),
          "harga_jual": parseFloat(document.getElementById('harga_jual_update').value)
        }

        console.log(body)

        const result = await updateToGudang(data.id_barang, body);
        if(result) {
          buildSectionGudang();
        }
      })
    }
    
    const buildSectionGudang = async () => {
      const datas = await getData();
      container.innerHTML = '';
      container.innerHTML += `
        <h3>status gudang</h3>
        <table>
          <tr>
            <th>ID</th>
            <th>Nama Barang</th>
            <th>Stok</th>
            <th>Harga Jual</th>
            <th>Aksi</th>
          </tr>
      `;

      const table = container.querySelector('table');
      for (const data of datas) {
        table.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${data.id_barang}</td>
            <td>${data.nama_barang}</td>
            <td>${data.stok}</td>
            <td>${data.harga_jual}</td>
            <td><button onclick='buildSectionUpdateGudang(${JSON.stringify(data)})'>edit</button></td>
          </tr>
        `);
      }
      container.innerHTML += '</table>'
    }
    
    buildSectionGudang();

    form.addEventListener('submit', async (event) => {
      event.preventDefault(); // Prevent default form submission

      const body = {
        "id_barang": parseInt(document.getElementById('id_barang').value),
        "nama_barang": document.getElementById('nama_barang').value,
        "stok": parseInt(document.getElementById('stok').value),
        "harga_jual": parseFloat(document.getElementById('harga_jual').value)
      }

      console.log(body)

      const result = await postToGudang(body);
      if(result) {
        buildSectionGudang();
      }
    });

  </script>
</body>
</html>